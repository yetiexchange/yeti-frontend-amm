{"ast":null,"code":"\"use strict\"; // Copyright (c) 2018-2020 WalletLink.org <https://www.walletlink.org/>\n// Copyright (c) 2018-2020 Coinbase, Inc. <https://www.coinbase.com/>\n// Licensed under the Apache License, version 2.0\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n      d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.WalletLinkRelay = void 0;\n\nconst bind_decorator_1 = __importDefault(require(\"bind-decorator\"));\n\nconst crypto_1 = __importDefault(require(\"crypto\"));\n\nconst rxjs_1 = require(\"rxjs\");\n\nconst operators_1 = require(\"rxjs/operators\");\n\nconst url_1 = __importDefault(require(\"url\"));\n\nconst LinkFlow_1 = require(\"../components/LinkFlow\");\n\nconst Snackbar_1 = require(\"../components/Snackbar\");\n\nconst WalletLinkConnection_1 = require(\"../connection/WalletLinkConnection\");\n\nconst ScopedLocalStorage_1 = require(\"../lib/ScopedLocalStorage\");\n\nconst util_1 = require(\"../util\");\n\nconst aes256gcm = __importStar(require(\"./aes256gcm\"));\n\nconst Session_1 = require(\"./Session\");\n\nconst Web3Method_1 = require(\"./Web3Method\");\n\nconst Web3RequestCanceledMessage_1 = require(\"./Web3RequestCanceledMessage\");\n\nconst Web3RequestMessage_1 = require(\"./Web3RequestMessage\");\n\nconst Web3Response_1 = require(\"./Web3Response\");\n\nconst Web3ResponseMessage_1 = require(\"./Web3ResponseMessage\");\n\nclass WalletLinkRelay {\n  constructor(options) {\n    this.appName = \"\";\n    this.appLogoUrl = null;\n    this.attached = false;\n    this.walletLinkUrl = options.walletLinkUrl;\n    const u = url_1.default.parse(this.walletLinkUrl);\n    this.walletLinkOrigin = `${u.protocol}//${u.host}`;\n    this.storage = new ScopedLocalStorage_1.ScopedLocalStorage(`-walletlink:${this.walletLinkOrigin}`);\n    this.session = Session_1.Session.load(this.storage) || new Session_1.Session(this.storage).save();\n    this.connection = new WalletLinkConnection_1.WalletLinkConnection(this.session.id, this.session.key, this.walletLinkUrl);\n    this.connection.incomingEvent$.pipe(operators_1.filter(m => m.event === \"Web3Response\")).subscribe({\n      next: this.handleIncomingEvent\n    }); // if session is marked destroyed, reset and reload\n\n    this.connection.sessionConfig$.pipe(operators_1.filter(c => !!c.metadata && c.metadata.__destroyed === \"1\")).subscribe({\n      next: this.resetAndReload\n    });\n    this.snackbar = new Snackbar_1.Snackbar({\n      darkMode: options.darkMode\n    });\n    this.linkFlow = new LinkFlow_1.LinkFlow({\n      darkMode: options.darkMode,\n      version: options.version,\n      sessionId: this.session.id,\n      sessionSecret: this.session.secret,\n      walletLinkUrl: this.walletLinkUrl,\n      connected$: this.connection.connected$\n    });\n    this.connection.connect();\n  }\n\n  resetAndReload() {\n    this.connection.setSessionMetadata(\"__destroyed\", \"1\").pipe(operators_1.timeout(1000), operators_1.catchError(_ => rxjs_1.of(null))).subscribe(_ => {\n      this.connection.destroy();\n      this.storage.clear();\n      document.location.reload();\n    });\n  }\n\n  setAppInfo(appName, appLogoUrl) {\n    this.appName = appName;\n    this.appLogoUrl = appLogoUrl;\n  }\n\n  attach(el) {\n    if (this.attached) {\n      throw new Error(\"WalletLinkRelay is already attached\");\n    }\n\n    const container = document.createElement(\"div\");\n    container.className = \"-walletlink-css-reset\";\n    el.appendChild(container);\n    this.linkFlow.attach(container);\n    this.snackbar.attach(container);\n  }\n\n  getStorageItem(key) {\n    return this.storage.getItem(key);\n  }\n\n  setStorageItem(key, value) {\n    this.storage.setItem(key, value);\n  }\n\n  requestEthereumAccounts() {\n    return this.sendRequest({\n      method: Web3Method_1.Web3Method.requestEthereumAccounts,\n      params: {\n        appName: this.appName,\n        appLogoUrl: this.appLogoUrl || null\n      }\n    });\n  }\n\n  signEthereumMessage(message, address, addPrefix, typedDataJson) {\n    return this.sendRequest({\n      method: Web3Method_1.Web3Method.signEthereumMessage,\n      params: {\n        message: util_1.hexStringFromBuffer(message, true),\n        address,\n        addPrefix,\n        typedDataJson: typedDataJson || null\n      }\n    });\n  }\n\n  ethereumAddressFromSignedMessage(message, signature, addPrefix) {\n    return this.sendRequest({\n      method: Web3Method_1.Web3Method.ethereumAddressFromSignedMessage,\n      params: {\n        message: util_1.hexStringFromBuffer(message, true),\n        signature: util_1.hexStringFromBuffer(signature, true),\n        addPrefix\n      }\n    });\n  }\n\n  signEthereumTransaction(params) {\n    return this.sendRequest({\n      method: Web3Method_1.Web3Method.signEthereumTransaction,\n      params: {\n        fromAddress: params.fromAddress,\n        toAddress: params.toAddress,\n        weiValue: util_1.bigIntStringFromBN(params.weiValue),\n        data: util_1.hexStringFromBuffer(params.data, true),\n        nonce: params.nonce,\n        gasPriceInWei: params.gasPriceInWei ? util_1.bigIntStringFromBN(params.gasPriceInWei) : null,\n        gasLimit: params.gasLimit ? util_1.bigIntStringFromBN(params.gasLimit) : null,\n        chainId: params.chainId,\n        shouldSubmit: false\n      }\n    });\n  }\n\n  signAndSubmitEthereumTransaction(params) {\n    return this.sendRequest({\n      method: Web3Method_1.Web3Method.signEthereumTransaction,\n      params: {\n        fromAddress: params.fromAddress,\n        toAddress: params.toAddress,\n        weiValue: util_1.bigIntStringFromBN(params.weiValue),\n        data: util_1.hexStringFromBuffer(params.data, true),\n        nonce: params.nonce,\n        gasPriceInWei: params.gasPriceInWei ? util_1.bigIntStringFromBN(params.gasPriceInWei) : null,\n        gasLimit: params.gasLimit ? util_1.bigIntStringFromBN(params.gasLimit) : null,\n        chainId: params.chainId,\n        shouldSubmit: true\n      }\n    });\n  }\n\n  submitEthereumTransaction(signedTransaction, chainId) {\n    return this.sendRequest({\n      method: Web3Method_1.Web3Method.submitEthereumTransaction,\n      params: {\n        signedTransaction: util_1.hexStringFromBuffer(signedTransaction, true),\n        chainId\n      }\n    });\n  }\n\n  scanQRCode(regExp) {\n    return this.sendRequest({\n      method: Web3Method_1.Web3Method.scanQRCode,\n      params: {\n        regExp\n      }\n    });\n  }\n\n  arbitraryRequest(data) {\n    return this.sendRequest({\n      method: Web3Method_1.Web3Method.arbitrary,\n      params: {\n        data\n      }\n    });\n  }\n\n  sendRequest(request) {\n    return new Promise((resolve, reject) => {\n      let hideSnackbarItem = null;\n      const id = crypto_1.default.randomBytes(8).toString(\"hex\");\n      const isRequestAccounts = request.method === Web3Method_1.Web3Method.requestEthereumAccounts;\n\n      const cancel = () => {\n        this.publishWeb3RequestCanceledEvent(id);\n        this.handleWeb3ResponseMessage(Web3ResponseMessage_1.Web3ResponseMessage({\n          id,\n          response: Web3Response_1.ErrorResponse(request.method, \"User rejected request\")\n        }));\n        hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n      };\n\n      if (isRequestAccounts) {\n        this.linkFlow.open({\n          onCancel: cancel\n        });\n        WalletLinkRelay.accountRequestCallbackIds.add(id);\n      } else {\n        const snackbarProps = {\n          message: \"Pushed a request to your wallet...\",\n          showProgressBar: true,\n          actions: [{\n            info: \"Made a mistake?\",\n            buttonLabel: \"Cancel\",\n            onClick: cancel\n          }, {\n            info: \"Not receiving requests?\",\n            buttonLabel: \"Reset Connection\",\n            onClick: this.resetAndReload\n          }]\n        };\n        hideSnackbarItem = this.snackbar.presentItem(snackbarProps);\n      }\n\n      WalletLinkRelay.callbacks.set(id, response => {\n        this.linkFlow.close();\n        hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n\n        if (response.errorMessage) {\n          return reject(new Error(response.errorMessage));\n        }\n\n        resolve(response);\n      });\n      this.publishWeb3RequestEvent(id, request);\n    });\n  }\n\n  publishWeb3RequestEvent(id, request) {\n    const message = Web3RequestMessage_1.Web3RequestMessage({\n      id,\n      request\n    });\n    this.publishEvent(\"Web3Request\", message, true).subscribe({\n      error: err => {\n        this.handleWeb3ResponseMessage(Web3ResponseMessage_1.Web3ResponseMessage({\n          id: message.id,\n          response: {\n            method: message.request.method,\n            errorMessage: err.message\n          }\n        }));\n      }\n    });\n  }\n\n  publishWeb3RequestCanceledEvent(id) {\n    const message = Web3RequestCanceledMessage_1.Web3RequestCanceledMessage(id);\n    this.publishEvent(\"Web3RequestCanceled\", message, false).subscribe();\n  }\n\n  publishEvent(event, message, callWebhook) {\n    const encrypted = aes256gcm.encrypt(JSON.stringify(Object.assign(Object.assign({}, message), {\n      origin: location.origin\n    })), this.session.secret);\n    return this.connection.publishEvent(event, encrypted, callWebhook);\n  }\n\n  handleIncomingEvent(event) {\n    let json;\n\n    try {\n      json = JSON.parse(aes256gcm.decrypt(event.data, this.session.secret));\n    } catch (_a) {\n      return;\n    }\n\n    const message = Web3ResponseMessage_1.isWeb3ResponseMessage(json) ? json : null;\n\n    if (!message) {\n      return;\n    }\n\n    this.handleWeb3ResponseMessage(message);\n  }\n\n  handleWeb3ResponseMessage(message) {\n    const {\n      response\n    } = message;\n\n    if (Web3Response_1.isRequestEthereumAccountsResponse(response)) {\n      Array.from(WalletLinkRelay.accountRequestCallbackIds.values()).forEach(id => this.invokeCallback(Object.assign(Object.assign({}, message), {\n        id\n      })));\n      WalletLinkRelay.accountRequestCallbackIds.clear();\n      return;\n    }\n\n    this.invokeCallback(message);\n  }\n\n  invokeCallback(message) {\n    const callback = WalletLinkRelay.callbacks.get(message.id);\n\n    if (callback) {\n      callback(message.response);\n      WalletLinkRelay.callbacks.delete(message.id);\n    }\n  }\n\n}\n\nWalletLinkRelay.callbacks = new Map();\nWalletLinkRelay.accountRequestCallbackIds = new Set();\n\n__decorate([bind_decorator_1.default], WalletLinkRelay.prototype, \"resetAndReload\", null);\n\n__decorate([bind_decorator_1.default], WalletLinkRelay.prototype, \"handleIncomingEvent\", null);\n\nexports.WalletLinkRelay = WalletLinkRelay;","map":{"version":3,"sources":["H:/XETI/YETI-AMM-DEV/node_modules/walletlink/dist/relay/WalletLinkRelay.js"],"names":["__createBinding","Object","create","o","m","k","k2","undefined","defineProperty","enumerable","get","__setModuleDefault","v","value","__decorate","decorators","target","key","desc","c","arguments","length","r","getOwnPropertyDescriptor","d","Reflect","decorate","i","__importStar","mod","__esModule","result","hasOwnProperty","call","__importDefault","exports","WalletLinkRelay","bind_decorator_1","require","crypto_1","rxjs_1","operators_1","url_1","LinkFlow_1","Snackbar_1","WalletLinkConnection_1","ScopedLocalStorage_1","util_1","aes256gcm","Session_1","Web3Method_1","Web3RequestCanceledMessage_1","Web3RequestMessage_1","Web3Response_1","Web3ResponseMessage_1","constructor","options","appName","appLogoUrl","attached","walletLinkUrl","u","default","parse","walletLinkOrigin","protocol","host","storage","ScopedLocalStorage","session","Session","load","save","connection","WalletLinkConnection","id","incomingEvent$","pipe","filter","event","subscribe","next","handleIncomingEvent","sessionConfig$","metadata","__destroyed","resetAndReload","snackbar","Snackbar","darkMode","linkFlow","LinkFlow","version","sessionId","sessionSecret","secret","connected$","connect","setSessionMetadata","timeout","catchError","_","of","destroy","clear","document","location","reload","setAppInfo","attach","el","Error","container","createElement","className","appendChild","getStorageItem","getItem","setStorageItem","setItem","requestEthereumAccounts","sendRequest","method","Web3Method","params","signEthereumMessage","message","address","addPrefix","typedDataJson","hexStringFromBuffer","ethereumAddressFromSignedMessage","signature","signEthereumTransaction","fromAddress","toAddress","weiValue","bigIntStringFromBN","data","nonce","gasPriceInWei","gasLimit","chainId","shouldSubmit","signAndSubmitEthereumTransaction","submitEthereumTransaction","signedTransaction","scanQRCode","regExp","arbitraryRequest","arbitrary","request","Promise","resolve","reject","hideSnackbarItem","randomBytes","toString","isRequestAccounts","cancel","publishWeb3RequestCanceledEvent","handleWeb3ResponseMessage","Web3ResponseMessage","response","ErrorResponse","open","onCancel","accountRequestCallbackIds","add","snackbarProps","showProgressBar","actions","info","buttonLabel","onClick","presentItem","callbacks","set","close","errorMessage","publishWeb3RequestEvent","Web3RequestMessage","publishEvent","error","err","Web3RequestCanceledMessage","callWebhook","encrypted","encrypt","JSON","stringify","assign","origin","json","decrypt","_a","isWeb3ResponseMessage","isRequestEthereumAccountsResponse","Array","from","values","forEach","invokeCallback","callback","delete","Map","Set","prototype"],"mappings":"AAAA,a,CACA;AACA;AACA;;AACA,IAAIA,eAAe,GAAI,QAAQ,KAAKA,eAAd,KAAmCC,MAAM,CAACC,MAAP,GAAiB,UAASC,CAAT,EAAYC,CAAZ,EAAeC,CAAf,EAAkBC,EAAlB,EAAsB;AAC5F,MAAIA,EAAE,KAAKC,SAAX,EAAsBD,EAAE,GAAGD,CAAL;AACtBJ,EAAAA,MAAM,CAACO,cAAP,CAAsBL,CAAtB,EAAyBG,EAAzB,EAA6B;AAAEG,IAAAA,UAAU,EAAE,IAAd;AAAoBC,IAAAA,GAAG,EAAE,YAAW;AAAE,aAAON,CAAC,CAACC,CAAD,CAAR;AAAc;AAApD,GAA7B;AACH,CAHwD,GAGnD,UAASF,CAAT,EAAYC,CAAZ,EAAeC,CAAf,EAAkBC,EAAlB,EAAsB;AACxB,MAAIA,EAAE,KAAKC,SAAX,EAAsBD,EAAE,GAAGD,CAAL;AACtBF,EAAAA,CAAC,CAACG,EAAD,CAAD,GAAQF,CAAC,CAACC,CAAD,CAAT;AACH,CANqB,CAAtB;;AAOA,IAAIM,kBAAkB,GAAI,QAAQ,KAAKA,kBAAd,KAAsCV,MAAM,CAACC,MAAP,GAAiB,UAASC,CAAT,EAAYS,CAAZ,EAAe;AAC3FX,EAAAA,MAAM,CAACO,cAAP,CAAsBL,CAAtB,EAAyB,SAAzB,EAAoC;AAAEM,IAAAA,UAAU,EAAE,IAAd;AAAoBI,IAAAA,KAAK,EAAED;AAA3B,GAApC;AACH,CAF8D,GAE1D,UAAST,CAAT,EAAYS,CAAZ,EAAe;AAChBT,EAAAA,CAAC,CAAC,SAAD,CAAD,GAAeS,CAAf;AACH,CAJwB,CAAzB;;AAKA,IAAIE,UAAU,GAAI,QAAQ,KAAKA,UAAd,IAA6B,UAAUC,UAAV,EAAsBC,MAAtB,EAA8BC,GAA9B,EAAmCC,IAAnC,EAAyC;AACnF,MAAIC,CAAC,GAAGC,SAAS,CAACC,MAAlB;AAAA,MAA0BC,CAAC,GAAGH,CAAC,GAAG,CAAJ,GAAQH,MAAR,GAAiBE,IAAI,KAAK,IAAT,GAAgBA,IAAI,GAAGjB,MAAM,CAACsB,wBAAP,CAAgCP,MAAhC,EAAwCC,GAAxC,CAAvB,GAAsEC,IAArH;AAAA,MAA2HM,CAA3H;AACA,MAAI,OAAOC,OAAP,KAAmB,QAAnB,IAA+B,OAAOA,OAAO,CAACC,QAAf,KAA4B,UAA/D,EAA2EJ,CAAC,GAAGG,OAAO,CAACC,QAAR,CAAiBX,UAAjB,EAA6BC,MAA7B,EAAqCC,GAArC,EAA0CC,IAA1C,CAAJ,CAA3E,KACK,KAAK,IAAIS,CAAC,GAAGZ,UAAU,CAACM,MAAX,GAAoB,CAAjC,EAAoCM,CAAC,IAAI,CAAzC,EAA4CA,CAAC,EAA7C,EAAiD,IAAIH,CAAC,GAAGT,UAAU,CAACY,CAAD,CAAlB,EAAuBL,CAAC,GAAG,CAACH,CAAC,GAAG,CAAJ,GAAQK,CAAC,CAACF,CAAD,CAAT,GAAeH,CAAC,GAAG,CAAJ,GAAQK,CAAC,CAACR,MAAD,EAASC,GAAT,EAAcK,CAAd,CAAT,GAA4BE,CAAC,CAACR,MAAD,EAASC,GAAT,CAA7C,KAA+DK,CAAnE;AAC7E,SAAOH,CAAC,GAAG,CAAJ,IAASG,CAAT,IAAcrB,MAAM,CAACO,cAAP,CAAsBQ,MAAtB,EAA8BC,GAA9B,EAAmCK,CAAnC,CAAd,EAAqDA,CAA5D;AACH,CALD;;AAMA,IAAIM,YAAY,GAAI,QAAQ,KAAKA,YAAd,IAA+B,UAAUC,GAAV,EAAe;AAC7D,MAAIA,GAAG,IAAIA,GAAG,CAACC,UAAf,EAA2B,OAAOD,GAAP;AAC3B,MAAIE,MAAM,GAAG,EAAb;AACA,MAAIF,GAAG,IAAI,IAAX,EAAiB,KAAK,IAAIxB,CAAT,IAAcwB,GAAd,EAAmB,IAAIxB,CAAC,KAAK,SAAN,IAAmBJ,MAAM,CAAC+B,cAAP,CAAsBC,IAAtB,CAA2BJ,GAA3B,EAAgCxB,CAAhC,CAAvB,EAA2DL,eAAe,CAAC+B,MAAD,EAASF,GAAT,EAAcxB,CAAd,CAAf;;AAC/FM,EAAAA,kBAAkB,CAACoB,MAAD,EAASF,GAAT,CAAlB;;AACA,SAAOE,MAAP;AACH,CAND;;AAOA,IAAIG,eAAe,GAAI,QAAQ,KAAKA,eAAd,IAAkC,UAAUL,GAAV,EAAe;AACnE,SAAQA,GAAG,IAAIA,GAAG,CAACC,UAAZ,GAA0BD,GAA1B,GAAgC;AAAE,eAAWA;AAAb,GAAvC;AACH,CAFD;;AAGA5B,MAAM,CAACO,cAAP,CAAsB2B,OAAtB,EAA+B,YAA/B,EAA6C;AAAEtB,EAAAA,KAAK,EAAE;AAAT,CAA7C;AACAsB,OAAO,CAACC,eAAR,GAA0B,KAAK,CAA/B;;AACA,MAAMC,gBAAgB,GAAGH,eAAe,CAACI,OAAO,CAAC,gBAAD,CAAR,CAAxC;;AACA,MAAMC,QAAQ,GAAGL,eAAe,CAACI,OAAO,CAAC,QAAD,CAAR,CAAhC;;AACA,MAAME,MAAM,GAAGF,OAAO,CAAC,MAAD,CAAtB;;AACA,MAAMG,WAAW,GAAGH,OAAO,CAAC,gBAAD,CAA3B;;AACA,MAAMI,KAAK,GAAGR,eAAe,CAACI,OAAO,CAAC,KAAD,CAAR,CAA7B;;AACA,MAAMK,UAAU,GAAGL,OAAO,CAAC,wBAAD,CAA1B;;AACA,MAAMM,UAAU,GAAGN,OAAO,CAAC,wBAAD,CAA1B;;AACA,MAAMO,sBAAsB,GAAGP,OAAO,CAAC,oCAAD,CAAtC;;AACA,MAAMQ,oBAAoB,GAAGR,OAAO,CAAC,2BAAD,CAApC;;AACA,MAAMS,MAAM,GAAGT,OAAO,CAAC,SAAD,CAAtB;;AACA,MAAMU,SAAS,GAAGpB,YAAY,CAACU,OAAO,CAAC,aAAD,CAAR,CAA9B;;AACA,MAAMW,SAAS,GAAGX,OAAO,CAAC,WAAD,CAAzB;;AACA,MAAMY,YAAY,GAAGZ,OAAO,CAAC,cAAD,CAA5B;;AACA,MAAMa,4BAA4B,GAAGb,OAAO,CAAC,8BAAD,CAA5C;;AACA,MAAMc,oBAAoB,GAAGd,OAAO,CAAC,sBAAD,CAApC;;AACA,MAAMe,cAAc,GAAGf,OAAO,CAAC,gBAAD,CAA9B;;AACA,MAAMgB,qBAAqB,GAAGhB,OAAO,CAAC,uBAAD,CAArC;;AACA,MAAMF,eAAN,CAAsB;AAClBmB,EAAAA,WAAW,CAACC,OAAD,EAAU;AACjB,SAAKC,OAAL,GAAe,EAAf;AACA,SAAKC,UAAL,GAAkB,IAAlB;AACA,SAAKC,QAAL,GAAgB,KAAhB;AACA,SAAKC,aAAL,GAAqBJ,OAAO,CAACI,aAA7B;AACA,UAAMC,CAAC,GAAGnB,KAAK,CAACoB,OAAN,CAAcC,KAAd,CAAoB,KAAKH,aAAzB,CAAV;AACA,SAAKI,gBAAL,GAAyB,GAAEH,CAAC,CAACI,QAAS,KAAIJ,CAAC,CAACK,IAAK,EAAjD;AACA,SAAKC,OAAL,GAAe,IAAIrB,oBAAoB,CAACsB,kBAAzB,CAA6C,eAAc,KAAKJ,gBAAiB,EAAjF,CAAf;AACA,SAAKK,OAAL,GACIpB,SAAS,CAACqB,OAAV,CAAkBC,IAAlB,CAAuB,KAAKJ,OAA5B,KAAwC,IAAIlB,SAAS,CAACqB,OAAd,CAAsB,KAAKH,OAA3B,EAAoCK,IAApC,EAD5C;AAEA,SAAKC,UAAL,GAAkB,IAAI5B,sBAAsB,CAAC6B,oBAA3B,CAAgD,KAAKL,OAAL,CAAaM,EAA7D,EAAiE,KAAKN,OAAL,CAAapD,GAA9E,EAAmF,KAAK2C,aAAxF,CAAlB;AACA,SAAKa,UAAL,CAAgBG,cAAhB,CACKC,IADL,CACUpC,WAAW,CAACqC,MAAZ,CAAmB1E,CAAC,IAAIA,CAAC,CAAC2E,KAAF,KAAY,cAApC,CADV,EAEKC,SAFL,CAEe;AAAEC,MAAAA,IAAI,EAAE,KAAKC;AAAb,KAFf,EAXiB,CAcjB;;AACA,SAAKT,UAAL,CAAgBU,cAAhB,CACKN,IADL,CACUpC,WAAW,CAACqC,MAAZ,CAAmB3D,CAAC,IAAI,CAAC,CAACA,CAAC,CAACiE,QAAJ,IAAgBjE,CAAC,CAACiE,QAAF,CAAWC,WAAX,KAA2B,GAAnE,CADV,EAEKL,SAFL,CAEe;AAAEC,MAAAA,IAAI,EAAE,KAAKK;AAAb,KAFf;AAGA,SAAKC,QAAL,GAAgB,IAAI3C,UAAU,CAAC4C,QAAf,CAAwB;AACpCC,MAAAA,QAAQ,EAAEjC,OAAO,CAACiC;AADkB,KAAxB,CAAhB;AAGA,SAAKC,QAAL,GAAgB,IAAI/C,UAAU,CAACgD,QAAf,CAAwB;AACpCF,MAAAA,QAAQ,EAAEjC,OAAO,CAACiC,QADkB;AAEpCG,MAAAA,OAAO,EAAEpC,OAAO,CAACoC,OAFmB;AAGpCC,MAAAA,SAAS,EAAE,KAAKxB,OAAL,CAAaM,EAHY;AAIpCmB,MAAAA,aAAa,EAAE,KAAKzB,OAAL,CAAa0B,MAJQ;AAKpCnC,MAAAA,aAAa,EAAE,KAAKA,aALgB;AAMpCoC,MAAAA,UAAU,EAAE,KAAKvB,UAAL,CAAgBuB;AANQ,KAAxB,CAAhB;AAQA,SAAKvB,UAAL,CAAgBwB,OAAhB;AACH;;AACDX,EAAAA,cAAc,GAAG;AACb,SAAKb,UAAL,CACKyB,kBADL,CACwB,aADxB,EACuC,GADvC,EAEKrB,IAFL,CAEUpC,WAAW,CAAC0D,OAAZ,CAAoB,IAApB,CAFV,EAEqC1D,WAAW,CAAC2D,UAAZ,CAAuBC,CAAC,IAAI7D,MAAM,CAAC8D,EAAP,CAAU,IAAV,CAA5B,CAFrC,EAGKtB,SAHL,CAGeqB,CAAC,IAAI;AAChB,WAAK5B,UAAL,CAAgB8B,OAAhB;AACA,WAAKpC,OAAL,CAAaqC,KAAb;AACAC,MAAAA,QAAQ,CAACC,QAAT,CAAkBC,MAAlB;AACH,KAPD;AAQH;;AACDC,EAAAA,UAAU,CAACnD,OAAD,EAAUC,UAAV,EAAsB;AAC5B,SAAKD,OAAL,GAAeA,OAAf;AACA,SAAKC,UAAL,GAAkBA,UAAlB;AACH;;AACDmD,EAAAA,MAAM,CAACC,EAAD,EAAK;AACP,QAAI,KAAKnD,QAAT,EAAmB;AACf,YAAM,IAAIoD,KAAJ,CAAU,qCAAV,CAAN;AACH;;AACD,UAAMC,SAAS,GAAGP,QAAQ,CAACQ,aAAT,CAAuB,KAAvB,CAAlB;AACAD,IAAAA,SAAS,CAACE,SAAV,GAAsB,uBAAtB;AACAJ,IAAAA,EAAE,CAACK,WAAH,CAAeH,SAAf;AACA,SAAKtB,QAAL,CAAcmB,MAAd,CAAqBG,SAArB;AACA,SAAKzB,QAAL,CAAcsB,MAAd,CAAqBG,SAArB;AACH;;AACDI,EAAAA,cAAc,CAACnG,GAAD,EAAM;AAChB,WAAO,KAAKkD,OAAL,CAAakD,OAAb,CAAqBpG,GAArB,CAAP;AACH;;AACDqG,EAAAA,cAAc,CAACrG,GAAD,EAAMJ,KAAN,EAAa;AACvB,SAAKsD,OAAL,CAAaoD,OAAb,CAAqBtG,GAArB,EAA0BJ,KAA1B;AACH;;AACD2G,EAAAA,uBAAuB,GAAG;AACtB,WAAO,KAAKC,WAAL,CAAiB;AACpBC,MAAAA,MAAM,EAAExE,YAAY,CAACyE,UAAb,CAAwBH,uBADZ;AAEpBI,MAAAA,MAAM,EAAE;AACJnE,QAAAA,OAAO,EAAE,KAAKA,OADV;AAEJC,QAAAA,UAAU,EAAE,KAAKA,UAAL,IAAmB;AAF3B;AAFY,KAAjB,CAAP;AAOH;;AACDmE,EAAAA,mBAAmB,CAACC,OAAD,EAAUC,OAAV,EAAmBC,SAAnB,EAA8BC,aAA9B,EAA6C;AAC5D,WAAO,KAAKR,WAAL,CAAiB;AACpBC,MAAAA,MAAM,EAAExE,YAAY,CAACyE,UAAb,CAAwBE,mBADZ;AAEpBD,MAAAA,MAAM,EAAE;AACJE,QAAAA,OAAO,EAAE/E,MAAM,CAACmF,mBAAP,CAA2BJ,OAA3B,EAAoC,IAApC,CADL;AAEJC,QAAAA,OAFI;AAGJC,QAAAA,SAHI;AAIJC,QAAAA,aAAa,EAAEA,aAAa,IAAI;AAJ5B;AAFY,KAAjB,CAAP;AASH;;AACDE,EAAAA,gCAAgC,CAACL,OAAD,EAAUM,SAAV,EAAqBJ,SAArB,EAAgC;AAC5D,WAAO,KAAKP,WAAL,CAAiB;AACpBC,MAAAA,MAAM,EAAExE,YAAY,CAACyE,UAAb,CAAwBQ,gCADZ;AAEpBP,MAAAA,MAAM,EAAE;AACJE,QAAAA,OAAO,EAAE/E,MAAM,CAACmF,mBAAP,CAA2BJ,OAA3B,EAAoC,IAApC,CADL;AAEJM,QAAAA,SAAS,EAAErF,MAAM,CAACmF,mBAAP,CAA2BE,SAA3B,EAAsC,IAAtC,CAFP;AAGJJ,QAAAA;AAHI;AAFY,KAAjB,CAAP;AAQH;;AACDK,EAAAA,uBAAuB,CAACT,MAAD,EAAS;AAC5B,WAAO,KAAKH,WAAL,CAAiB;AACpBC,MAAAA,MAAM,EAAExE,YAAY,CAACyE,UAAb,CAAwBU,uBADZ;AAEpBT,MAAAA,MAAM,EAAE;AACJU,QAAAA,WAAW,EAAEV,MAAM,CAACU,WADhB;AAEJC,QAAAA,SAAS,EAAEX,MAAM,CAACW,SAFd;AAGJC,QAAAA,QAAQ,EAAEzF,MAAM,CAAC0F,kBAAP,CAA0Bb,MAAM,CAACY,QAAjC,CAHN;AAIJE,QAAAA,IAAI,EAAE3F,MAAM,CAACmF,mBAAP,CAA2BN,MAAM,CAACc,IAAlC,EAAwC,IAAxC,CAJF;AAKJC,QAAAA,KAAK,EAAEf,MAAM,CAACe,KALV;AAMJC,QAAAA,aAAa,EAAEhB,MAAM,CAACgB,aAAP,GACT7F,MAAM,CAAC0F,kBAAP,CAA0Bb,MAAM,CAACgB,aAAjC,CADS,GAET,IARF;AASJC,QAAAA,QAAQ,EAAEjB,MAAM,CAACiB,QAAP,GAAkB9F,MAAM,CAAC0F,kBAAP,CAA0Bb,MAAM,CAACiB,QAAjC,CAAlB,GAA+D,IATrE;AAUJC,QAAAA,OAAO,EAAElB,MAAM,CAACkB,OAVZ;AAWJC,QAAAA,YAAY,EAAE;AAXV;AAFY,KAAjB,CAAP;AAgBH;;AACDC,EAAAA,gCAAgC,CAACpB,MAAD,EAAS;AACrC,WAAO,KAAKH,WAAL,CAAiB;AACpBC,MAAAA,MAAM,EAAExE,YAAY,CAACyE,UAAb,CAAwBU,uBADZ;AAEpBT,MAAAA,MAAM,EAAE;AACJU,QAAAA,WAAW,EAAEV,MAAM,CAACU,WADhB;AAEJC,QAAAA,SAAS,EAAEX,MAAM,CAACW,SAFd;AAGJC,QAAAA,QAAQ,EAAEzF,MAAM,CAAC0F,kBAAP,CAA0Bb,MAAM,CAACY,QAAjC,CAHN;AAIJE,QAAAA,IAAI,EAAE3F,MAAM,CAACmF,mBAAP,CAA2BN,MAAM,CAACc,IAAlC,EAAwC,IAAxC,CAJF;AAKJC,QAAAA,KAAK,EAAEf,MAAM,CAACe,KALV;AAMJC,QAAAA,aAAa,EAAEhB,MAAM,CAACgB,aAAP,GACT7F,MAAM,CAAC0F,kBAAP,CAA0Bb,MAAM,CAACgB,aAAjC,CADS,GAET,IARF;AASJC,QAAAA,QAAQ,EAAEjB,MAAM,CAACiB,QAAP,GAAkB9F,MAAM,CAAC0F,kBAAP,CAA0Bb,MAAM,CAACiB,QAAjC,CAAlB,GAA+D,IATrE;AAUJC,QAAAA,OAAO,EAAElB,MAAM,CAACkB,OAVZ;AAWJC,QAAAA,YAAY,EAAE;AAXV;AAFY,KAAjB,CAAP;AAgBH;;AACDE,EAAAA,yBAAyB,CAACC,iBAAD,EAAoBJ,OAApB,EAA6B;AAClD,WAAO,KAAKrB,WAAL,CAAiB;AACpBC,MAAAA,MAAM,EAAExE,YAAY,CAACyE,UAAb,CAAwBsB,yBADZ;AAEpBrB,MAAAA,MAAM,EAAE;AACJsB,QAAAA,iBAAiB,EAAEnG,MAAM,CAACmF,mBAAP,CAA2BgB,iBAA3B,EAA8C,IAA9C,CADf;AAEJJ,QAAAA;AAFI;AAFY,KAAjB,CAAP;AAOH;;AACDK,EAAAA,UAAU,CAACC,MAAD,EAAS;AACf,WAAO,KAAK3B,WAAL,CAAiB;AACpBC,MAAAA,MAAM,EAAExE,YAAY,CAACyE,UAAb,CAAwBwB,UADZ;AAEpBvB,MAAAA,MAAM,EAAE;AAAEwB,QAAAA;AAAF;AAFY,KAAjB,CAAP;AAIH;;AACDC,EAAAA,gBAAgB,CAACX,IAAD,EAAO;AACnB,WAAO,KAAKjB,WAAL,CAAiB;AACpBC,MAAAA,MAAM,EAAExE,YAAY,CAACyE,UAAb,CAAwB2B,SADZ;AAEpB1B,MAAAA,MAAM,EAAE;AAAEc,QAAAA;AAAF;AAFY,KAAjB,CAAP;AAIH;;AACDjB,EAAAA,WAAW,CAAC8B,OAAD,EAAU;AACjB,WAAO,IAAIC,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACpC,UAAIC,gBAAgB,GAAG,IAAvB;AACA,YAAMhF,EAAE,GAAGpC,QAAQ,CAACuB,OAAT,CAAiB8F,WAAjB,CAA6B,CAA7B,EAAgCC,QAAhC,CAAyC,KAAzC,CAAX;AACA,YAAMC,iBAAiB,GAAGP,OAAO,CAAC7B,MAAR,KAAmBxE,YAAY,CAACyE,UAAb,CAAwBH,uBAArE;;AACA,YAAMuC,MAAM,GAAG,MAAM;AACjB,aAAKC,+BAAL,CAAqCrF,EAArC;AACA,aAAKsF,yBAAL,CAA+B3G,qBAAqB,CAAC4G,mBAAtB,CAA0C;AACrEvF,UAAAA,EADqE;AAErEwF,UAAAA,QAAQ,EAAE9G,cAAc,CAAC+G,aAAf,CAA6Bb,OAAO,CAAC7B,MAArC,EAA6C,uBAA7C;AAF2D,SAA1C,CAA/B;AAIAiC,QAAAA,gBAAgB,KAAK,IAArB,IAA6BA,gBAAgB,KAAK,KAAK,CAAvD,GAA2D,KAAK,CAAhE,GAAoEA,gBAAgB,EAApF;AACH,OAPD;;AAQA,UAAIG,iBAAJ,EAAuB;AACnB,aAAKpE,QAAL,CAAc2E,IAAd,CAAmB;AAAEC,UAAAA,QAAQ,EAAEP;AAAZ,SAAnB;AACA3H,QAAAA,eAAe,CAACmI,yBAAhB,CAA0CC,GAA1C,CAA8C7F,EAA9C;AACH,OAHD,MAIK;AACD,cAAM8F,aAAa,GAAG;AAClB3C,UAAAA,OAAO,EAAE,oCADS;AAElB4C,UAAAA,eAAe,EAAE,IAFC;AAGlBC,UAAAA,OAAO,EAAE,CACL;AACIC,YAAAA,IAAI,EAAE,iBADV;AAEIC,YAAAA,WAAW,EAAE,QAFjB;AAGIC,YAAAA,OAAO,EAAEf;AAHb,WADK,EAML;AACIa,YAAAA,IAAI,EAAE,yBADV;AAEIC,YAAAA,WAAW,EAAE,kBAFjB;AAGIC,YAAAA,OAAO,EAAE,KAAKxF;AAHlB,WANK;AAHS,SAAtB;AAgBAqE,QAAAA,gBAAgB,GAAG,KAAKpE,QAAL,CAAcwF,WAAd,CAA0BN,aAA1B,CAAnB;AACH;;AACDrI,MAAAA,eAAe,CAAC4I,SAAhB,CAA0BC,GAA1B,CAA8BtG,EAA9B,EAAkCwF,QAAQ,IAAI;AAC1C,aAAKzE,QAAL,CAAcwF,KAAd;AACAvB,QAAAA,gBAAgB,KAAK,IAArB,IAA6BA,gBAAgB,KAAK,KAAK,CAAvD,GAA2D,KAAK,CAAhE,GAAoEA,gBAAgB,EAApF;;AACA,YAAIQ,QAAQ,CAACgB,YAAb,EAA2B;AACvB,iBAAOzB,MAAM,CAAC,IAAI3C,KAAJ,CAAUoD,QAAQ,CAACgB,YAAnB,CAAD,CAAb;AACH;;AACD1B,QAAAA,OAAO,CAACU,QAAD,CAAP;AACH,OAPD;AAQA,WAAKiB,uBAAL,CAA6BzG,EAA7B,EAAiC4E,OAAjC;AACH,KA5CM,CAAP;AA6CH;;AACD6B,EAAAA,uBAAuB,CAACzG,EAAD,EAAK4E,OAAL,EAAc;AACjC,UAAMzB,OAAO,GAAG1E,oBAAoB,CAACiI,kBAArB,CAAwC;AAAE1G,MAAAA,EAAF;AAAM4E,MAAAA;AAAN,KAAxC,CAAhB;AACA,SAAK+B,YAAL,CAAkB,aAAlB,EAAiCxD,OAAjC,EAA0C,IAA1C,EAAgD9C,SAAhD,CAA0D;AACtDuG,MAAAA,KAAK,EAAEC,GAAG,IAAI;AACV,aAAKvB,yBAAL,CAA+B3G,qBAAqB,CAAC4G,mBAAtB,CAA0C;AACrEvF,UAAAA,EAAE,EAAEmD,OAAO,CAACnD,EADyD;AAErEwF,UAAAA,QAAQ,EAAE;AACNzC,YAAAA,MAAM,EAAEI,OAAO,CAACyB,OAAR,CAAgB7B,MADlB;AAENyD,YAAAA,YAAY,EAAEK,GAAG,CAAC1D;AAFZ;AAF2D,SAA1C,CAA/B;AAOH;AATqD,KAA1D;AAWH;;AACDkC,EAAAA,+BAA+B,CAACrF,EAAD,EAAK;AAChC,UAAMmD,OAAO,GAAG3E,4BAA4B,CAACsI,0BAA7B,CAAwD9G,EAAxD,CAAhB;AACA,SAAK2G,YAAL,CAAkB,qBAAlB,EAAyCxD,OAAzC,EAAkD,KAAlD,EAAyD9C,SAAzD;AACH;;AACDsG,EAAAA,YAAY,CAACvG,KAAD,EAAQ+C,OAAR,EAAiB4D,WAAjB,EAA8B;AACtC,UAAMC,SAAS,GAAG3I,SAAS,CAAC4I,OAAV,CAAkBC,IAAI,CAACC,SAAL,CAAe7L,MAAM,CAAC8L,MAAP,CAAc9L,MAAM,CAAC8L,MAAP,CAAc,EAAd,EAAkBjE,OAAlB,CAAd,EAA0C;AAAEkE,MAAAA,MAAM,EAAEtF,QAAQ,CAACsF;AAAnB,KAA1C,CAAf,CAAlB,EAA0G,KAAK3H,OAAL,CAAa0B,MAAvH,CAAlB;AACA,WAAO,KAAKtB,UAAL,CAAgB6G,YAAhB,CAA6BvG,KAA7B,EAAoC4G,SAApC,EAA+CD,WAA/C,CAAP;AACH;;AACDxG,EAAAA,mBAAmB,CAACH,KAAD,EAAQ;AACvB,QAAIkH,IAAJ;;AACA,QAAI;AACAA,MAAAA,IAAI,GAAGJ,IAAI,CAAC9H,KAAL,CAAWf,SAAS,CAACkJ,OAAV,CAAkBnH,KAAK,CAAC2D,IAAxB,EAA8B,KAAKrE,OAAL,CAAa0B,MAA3C,CAAX,CAAP;AACH,KAFD,CAGA,OAAOoG,EAAP,EAAW;AACP;AACH;;AACD,UAAMrE,OAAO,GAAGxE,qBAAqB,CAAC8I,qBAAtB,CAA4CH,IAA5C,IAAoDA,IAApD,GAA2D,IAA3E;;AACA,QAAI,CAACnE,OAAL,EAAc;AACV;AACH;;AACD,SAAKmC,yBAAL,CAA+BnC,OAA/B;AACH;;AACDmC,EAAAA,yBAAyB,CAACnC,OAAD,EAAU;AAC/B,UAAM;AAAEqC,MAAAA;AAAF,QAAerC,OAArB;;AACA,QAAIzE,cAAc,CAACgJ,iCAAf,CAAiDlC,QAAjD,CAAJ,EAAgE;AAC5DmC,MAAAA,KAAK,CAACC,IAAN,CAAWnK,eAAe,CAACmI,yBAAhB,CAA0CiC,MAA1C,EAAX,EAA+DC,OAA/D,CAAuE9H,EAAE,IAAI,KAAK+H,cAAL,CAAoBzM,MAAM,CAAC8L,MAAP,CAAc9L,MAAM,CAAC8L,MAAP,CAAc,EAAd,EAAkBjE,OAAlB,CAAd,EAA0C;AAAEnD,QAAAA;AAAF,OAA1C,CAApB,CAA7E;AACAvC,MAAAA,eAAe,CAACmI,yBAAhB,CAA0C/D,KAA1C;AACA;AACH;;AACD,SAAKkG,cAAL,CAAoB5E,OAApB;AACH;;AACD4E,EAAAA,cAAc,CAAC5E,OAAD,EAAU;AACpB,UAAM6E,QAAQ,GAAGvK,eAAe,CAAC4I,SAAhB,CAA0BtK,GAA1B,CAA8BoH,OAAO,CAACnD,EAAtC,CAAjB;;AACA,QAAIgI,QAAJ,EAAc;AACVA,MAAAA,QAAQ,CAAC7E,OAAO,CAACqC,QAAT,CAAR;AACA/H,MAAAA,eAAe,CAAC4I,SAAhB,CAA0B4B,MAA1B,CAAiC9E,OAAO,CAACnD,EAAzC;AACH;AACJ;;AAvPiB;;AAyPtBvC,eAAe,CAAC4I,SAAhB,GAA4B,IAAI6B,GAAJ,EAA5B;AACAzK,eAAe,CAACmI,yBAAhB,GAA4C,IAAIuC,GAAJ,EAA5C;;AACAhM,UAAU,CAAC,CACPuB,gBAAgB,CAACyB,OADV,CAAD,EAEP1B,eAAe,CAAC2K,SAFT,EAEoB,gBAFpB,EAEsC,IAFtC,CAAV;;AAGAjM,UAAU,CAAC,CACPuB,gBAAgB,CAACyB,OADV,CAAD,EAEP1B,eAAe,CAAC2K,SAFT,EAEoB,qBAFpB,EAE2C,IAF3C,CAAV;;AAGA5K,OAAO,CAACC,eAAR,GAA0BA,eAA1B","sourcesContent":["\"use strict\";\n// Copyright (c) 2018-2020 WalletLink.org <https://www.walletlink.org/>\n// Copyright (c) 2018-2020 Coinbase, Inc. <https://www.coinbase.com/>\n// Licensed under the Apache License, version 2.0\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nvar __importStar = (this && this.__importStar) || function (mod) {\n    if (mod && mod.__esModule) return mod;\n    var result = {};\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n    __setModuleDefault(result, mod);\n    return result;\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.WalletLinkRelay = void 0;\nconst bind_decorator_1 = __importDefault(require(\"bind-decorator\"));\nconst crypto_1 = __importDefault(require(\"crypto\"));\nconst rxjs_1 = require(\"rxjs\");\nconst operators_1 = require(\"rxjs/operators\");\nconst url_1 = __importDefault(require(\"url\"));\nconst LinkFlow_1 = require(\"../components/LinkFlow\");\nconst Snackbar_1 = require(\"../components/Snackbar\");\nconst WalletLinkConnection_1 = require(\"../connection/WalletLinkConnection\");\nconst ScopedLocalStorage_1 = require(\"../lib/ScopedLocalStorage\");\nconst util_1 = require(\"../util\");\nconst aes256gcm = __importStar(require(\"./aes256gcm\"));\nconst Session_1 = require(\"./Session\");\nconst Web3Method_1 = require(\"./Web3Method\");\nconst Web3RequestCanceledMessage_1 = require(\"./Web3RequestCanceledMessage\");\nconst Web3RequestMessage_1 = require(\"./Web3RequestMessage\");\nconst Web3Response_1 = require(\"./Web3Response\");\nconst Web3ResponseMessage_1 = require(\"./Web3ResponseMessage\");\nclass WalletLinkRelay {\n    constructor(options) {\n        this.appName = \"\";\n        this.appLogoUrl = null;\n        this.attached = false;\n        this.walletLinkUrl = options.walletLinkUrl;\n        const u = url_1.default.parse(this.walletLinkUrl);\n        this.walletLinkOrigin = `${u.protocol}//${u.host}`;\n        this.storage = new ScopedLocalStorage_1.ScopedLocalStorage(`-walletlink:${this.walletLinkOrigin}`);\n        this.session =\n            Session_1.Session.load(this.storage) || new Session_1.Session(this.storage).save();\n        this.connection = new WalletLinkConnection_1.WalletLinkConnection(this.session.id, this.session.key, this.walletLinkUrl);\n        this.connection.incomingEvent$\n            .pipe(operators_1.filter(m => m.event === \"Web3Response\"))\n            .subscribe({ next: this.handleIncomingEvent });\n        // if session is marked destroyed, reset and reload\n        this.connection.sessionConfig$\n            .pipe(operators_1.filter(c => !!c.metadata && c.metadata.__destroyed === \"1\"))\n            .subscribe({ next: this.resetAndReload });\n        this.snackbar = new Snackbar_1.Snackbar({\n            darkMode: options.darkMode\n        });\n        this.linkFlow = new LinkFlow_1.LinkFlow({\n            darkMode: options.darkMode,\n            version: options.version,\n            sessionId: this.session.id,\n            sessionSecret: this.session.secret,\n            walletLinkUrl: this.walletLinkUrl,\n            connected$: this.connection.connected$\n        });\n        this.connection.connect();\n    }\n    resetAndReload() {\n        this.connection\n            .setSessionMetadata(\"__destroyed\", \"1\")\n            .pipe(operators_1.timeout(1000), operators_1.catchError(_ => rxjs_1.of(null)))\n            .subscribe(_ => {\n            this.connection.destroy();\n            this.storage.clear();\n            document.location.reload();\n        });\n    }\n    setAppInfo(appName, appLogoUrl) {\n        this.appName = appName;\n        this.appLogoUrl = appLogoUrl;\n    }\n    attach(el) {\n        if (this.attached) {\n            throw new Error(\"WalletLinkRelay is already attached\");\n        }\n        const container = document.createElement(\"div\");\n        container.className = \"-walletlink-css-reset\";\n        el.appendChild(container);\n        this.linkFlow.attach(container);\n        this.snackbar.attach(container);\n    }\n    getStorageItem(key) {\n        return this.storage.getItem(key);\n    }\n    setStorageItem(key, value) {\n        this.storage.setItem(key, value);\n    }\n    requestEthereumAccounts() {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.requestEthereumAccounts,\n            params: {\n                appName: this.appName,\n                appLogoUrl: this.appLogoUrl || null\n            }\n        });\n    }\n    signEthereumMessage(message, address, addPrefix, typedDataJson) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.signEthereumMessage,\n            params: {\n                message: util_1.hexStringFromBuffer(message, true),\n                address,\n                addPrefix,\n                typedDataJson: typedDataJson || null\n            }\n        });\n    }\n    ethereumAddressFromSignedMessage(message, signature, addPrefix) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.ethereumAddressFromSignedMessage,\n            params: {\n                message: util_1.hexStringFromBuffer(message, true),\n                signature: util_1.hexStringFromBuffer(signature, true),\n                addPrefix\n            }\n        });\n    }\n    signEthereumTransaction(params) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.signEthereumTransaction,\n            params: {\n                fromAddress: params.fromAddress,\n                toAddress: params.toAddress,\n                weiValue: util_1.bigIntStringFromBN(params.weiValue),\n                data: util_1.hexStringFromBuffer(params.data, true),\n                nonce: params.nonce,\n                gasPriceInWei: params.gasPriceInWei\n                    ? util_1.bigIntStringFromBN(params.gasPriceInWei)\n                    : null,\n                gasLimit: params.gasLimit ? util_1.bigIntStringFromBN(params.gasLimit) : null,\n                chainId: params.chainId,\n                shouldSubmit: false\n            }\n        });\n    }\n    signAndSubmitEthereumTransaction(params) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.signEthereumTransaction,\n            params: {\n                fromAddress: params.fromAddress,\n                toAddress: params.toAddress,\n                weiValue: util_1.bigIntStringFromBN(params.weiValue),\n                data: util_1.hexStringFromBuffer(params.data, true),\n                nonce: params.nonce,\n                gasPriceInWei: params.gasPriceInWei\n                    ? util_1.bigIntStringFromBN(params.gasPriceInWei)\n                    : null,\n                gasLimit: params.gasLimit ? util_1.bigIntStringFromBN(params.gasLimit) : null,\n                chainId: params.chainId,\n                shouldSubmit: true\n            }\n        });\n    }\n    submitEthereumTransaction(signedTransaction, chainId) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.submitEthereumTransaction,\n            params: {\n                signedTransaction: util_1.hexStringFromBuffer(signedTransaction, true),\n                chainId\n            }\n        });\n    }\n    scanQRCode(regExp) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.scanQRCode,\n            params: { regExp }\n        });\n    }\n    arbitraryRequest(data) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.arbitrary,\n            params: { data }\n        });\n    }\n    sendRequest(request) {\n        return new Promise((resolve, reject) => {\n            let hideSnackbarItem = null;\n            const id = crypto_1.default.randomBytes(8).toString(\"hex\");\n            const isRequestAccounts = request.method === Web3Method_1.Web3Method.requestEthereumAccounts;\n            const cancel = () => {\n                this.publishWeb3RequestCanceledEvent(id);\n                this.handleWeb3ResponseMessage(Web3ResponseMessage_1.Web3ResponseMessage({\n                    id,\n                    response: Web3Response_1.ErrorResponse(request.method, \"User rejected request\")\n                }));\n                hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n            };\n            if (isRequestAccounts) {\n                this.linkFlow.open({ onCancel: cancel });\n                WalletLinkRelay.accountRequestCallbackIds.add(id);\n            }\n            else {\n                const snackbarProps = {\n                    message: \"Pushed a request to your wallet...\",\n                    showProgressBar: true,\n                    actions: [\n                        {\n                            info: \"Made a mistake?\",\n                            buttonLabel: \"Cancel\",\n                            onClick: cancel\n                        },\n                        {\n                            info: \"Not receiving requests?\",\n                            buttonLabel: \"Reset Connection\",\n                            onClick: this.resetAndReload\n                        }\n                    ]\n                };\n                hideSnackbarItem = this.snackbar.presentItem(snackbarProps);\n            }\n            WalletLinkRelay.callbacks.set(id, response => {\n                this.linkFlow.close();\n                hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n                if (response.errorMessage) {\n                    return reject(new Error(response.errorMessage));\n                }\n                resolve(response);\n            });\n            this.publishWeb3RequestEvent(id, request);\n        });\n    }\n    publishWeb3RequestEvent(id, request) {\n        const message = Web3RequestMessage_1.Web3RequestMessage({ id, request });\n        this.publishEvent(\"Web3Request\", message, true).subscribe({\n            error: err => {\n                this.handleWeb3ResponseMessage(Web3ResponseMessage_1.Web3ResponseMessage({\n                    id: message.id,\n                    response: {\n                        method: message.request.method,\n                        errorMessage: err.message\n                    }\n                }));\n            }\n        });\n    }\n    publishWeb3RequestCanceledEvent(id) {\n        const message = Web3RequestCanceledMessage_1.Web3RequestCanceledMessage(id);\n        this.publishEvent(\"Web3RequestCanceled\", message, false).subscribe();\n    }\n    publishEvent(event, message, callWebhook) {\n        const encrypted = aes256gcm.encrypt(JSON.stringify(Object.assign(Object.assign({}, message), { origin: location.origin })), this.session.secret);\n        return this.connection.publishEvent(event, encrypted, callWebhook);\n    }\n    handleIncomingEvent(event) {\n        let json;\n        try {\n            json = JSON.parse(aes256gcm.decrypt(event.data, this.session.secret));\n        }\n        catch (_a) {\n            return;\n        }\n        const message = Web3ResponseMessage_1.isWeb3ResponseMessage(json) ? json : null;\n        if (!message) {\n            return;\n        }\n        this.handleWeb3ResponseMessage(message);\n    }\n    handleWeb3ResponseMessage(message) {\n        const { response } = message;\n        if (Web3Response_1.isRequestEthereumAccountsResponse(response)) {\n            Array.from(WalletLinkRelay.accountRequestCallbackIds.values()).forEach(id => this.invokeCallback(Object.assign(Object.assign({}, message), { id })));\n            WalletLinkRelay.accountRequestCallbackIds.clear();\n            return;\n        }\n        this.invokeCallback(message);\n    }\n    invokeCallback(message) {\n        const callback = WalletLinkRelay.callbacks.get(message.id);\n        if (callback) {\n            callback(message.response);\n            WalletLinkRelay.callbacks.delete(message.id);\n        }\n    }\n}\nWalletLinkRelay.callbacks = new Map();\nWalletLinkRelay.accountRequestCallbackIds = new Set();\n__decorate([\n    bind_decorator_1.default\n], WalletLinkRelay.prototype, \"resetAndReload\", null);\n__decorate([\n    bind_decorator_1.default\n], WalletLinkRelay.prototype, \"handleIncomingEvent\", null);\nexports.WalletLinkRelay = WalletLinkRelay;\n"]},"metadata":{},"sourceType":"script"}